(()=>{"use strict";var e={450:function(e,n,t){var r=this&&this.__awaiter||function(e,n,t,r){return new(t||(t=Promise))((function(o,i){function u(e){try{s(r.next(e))}catch(e){i(e)}}function a(e){try{s(r.throw(e))}catch(e){i(e)}}function s(e){var n;e.done?o(e.value):(n=e.value,n instanceof t?n:new t((function(e){e(n)}))).then(u,a)}s((r=r.apply(e,n||[])).next())}))},o=this&&this.__generator||function(e,n){var t,r,o,i,u={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function a(i){return function(a){return function(i){if(t)throw new TypeError("Generator is already executing.");for(;u;)try{if(t=1,r&&(o=2&i[0]?r.return:i[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,i[1])).done)return o;switch(r=0,o&&(i=[2&i[0],o.value]),i[0]){case 0:case 1:o=i;break;case 4:return u.label++,{value:i[1],done:!1};case 5:u.label++,r=i[1],i=[0];continue;case 7:i=u.ops.pop(),u.trys.pop();continue;default:if(!((o=(o=u.trys).length>0&&o[o.length-1])||6!==i[0]&&2!==i[0])){u=0;continue}if(3===i[0]&&(!o||i[1]>o[0]&&i[1]<o[3])){u.label=i[1];break}if(6===i[0]&&u.label<o[1]){u.label=o[1],o=i;break}if(o&&u.label<o[2]){u.label=o[2],u.ops.push(i);break}o[2]&&u.ops.pop(),u.trys.pop();continue}i=n.call(e,u)}catch(e){i=[6,e],r=0}finally{t=o=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,a])}}},i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(n,"__esModule",{value:!0});var u=i(t(376)),a=i(t(715)),s=i(t(349)),c=i(t(334)),l=i(t(127)),d=i(t(747)),f=i(t(225)),p=i(t(625)),h=i(t(249)),v=i(t(804)),m=i(t(874)),g=i(t(199)),y=i(t(622));c.default.config();var w=l.default(),b=process.env,_=b.IG_USERNAME,x=b.IG_PASSWORD,E=b.EMAIL_USERNAME,S=b.CONTENTFUL_SPACE_ID,q=b.CONTENTFUL_ACCESS_TOKEN,T=b.FIXIE_URL,I=m.default.simpleParser;w.use(l.default.static(y.default.join(__dirname,"/"))),g.default.schedule("* * * * *",(function(){return r(void 0,void 0,void 0,(function(){var e;return o(this,(function(n){switch(n.label){case 0:return[4,(e=function(){return r(void 0,void 0,void 0,(function(){var n,t,i,c,l,m,g;return o(this,(function(y){switch(y.label){case 0:return[4,(n=new p.default({username:_,password:x},{language:"en-US",proxy:T})).getPhotosByUsername({username:_}).then((function(e){e.user.edge_owner_to_timeline_media.edges.map((function(e){e.node.edge_media_to_caption.edges[0].node.text}))[0]})).then((function(e){Number(e.split(" - ")[0])})).then((function(e){var t=e+1,i="\n        query {\n          inkyDoodleCollection(where: {number: "+t+"}) {\n            items {\n              sys {\n                id\n              }\n              number,\n              generation,\n              name,\n              parents,\n              image {\n                url\n              }\n            }\n          }\n        }\n      ";u.default({url:"https://graphql.contentful.com/content/v1/space/"+S,method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer "+q},data:{query:i}}).then((function(e){return e.data})).then((function(e){var i=e.data,u=e.errors;if(u)return console.error(u);var c=i.inkyDoodleCollection.items[0];if(c){var l=t+" - "+c.name+"\n"+(c.parents&&c.parents.length>0?c.parents.map((function(e){return"#"+e})).join(" + ")+" \n":"")+"#inkyDoodle #gen"+c.generation;h.default.read(c.image.url).then((function(e){return e.resize(405,405,h.default.RESIZE_NEAREST_NEIGHBOR).quality(100).write("./"+c.name+".jpg",(function(){return r(void 0,void 0,void 0,(function(){return o(this,(function(e){switch(e.label){case 0:return[4,n.uploadPhoto({photo:c.name+".jpg",caption:l,post:"feed"}).then((function(e){var n=e.media;console.log("https://www.instagram.com/p/"+n.code),a.default.createClient({accessToken:q||""}).getSpace(S||"").then((function(e){e.getEnvironment("master").then((function(e){e.getEntry(c.sys.id).then((function(t){t.fields.instagram={"en-US":{url:"https://www.instagram.com/p/"+n.code,date:s.default().format("MMMM D, YYYY")}},t.update().then((function(){e.getEntry(c.sys.id).then((function(e){e.publish(),console.log("Entry updated successfully and published. New updated entry Instagram link is "+e.fields.instagram["en-US"].url)}))}))}))}))})),d.default.unlinkSync(c.name+".jpg")}))];case 1:return e.sent(),[2]}}))}))}))})).catch((function(e){return console.error(e)}))}}))}))];case 1:t=y.sent(),y.label=2;case 2:return y.trys.push([2,5,,9]),console.info("Logging in.."),[4,n.login()];case 3:return y.sent(),console.info("Login successful!"),[4,r(void 0,void 0,void 0,(function(){return o(this,(function(e){return setTimeout((function(){return r(void 0,void 0,void 0,(function(){return o(this,(function(e){switch(e.label){case 0:return[4,t()];case 1:return e.sent(),[2]}}))}))}),55e3),[2]}))}))];case 4:return y.sent(),[3,9];case 5:return i=y.sent(),c=i.error,l=i.status,console.error("Login failed.."),403===l?(console.error("Throttled!"),[2]):(console.error(c),c&&"checkpoint_required"===c.message?(m=c.checkpoint_required,[4,n.updateChallenge({challengeUrl:m,choices:1})]):[3,8]);case 6:return y.sent(),g={imap:{user:E||"",password:x||"",host:"imap.gmail.com",port:993,tls:!0,tlsOptions:{servername:"imap.gmail.com",rejectUnauthorized:!1},authTimeout:3e4}},[4,r(void 0,void 0,void 0,(function(){return o(this,(function(t){return setTimeout((function(){f.default.connect(g).then((function(t){return r(void 0,void 0,void 0,(function(){return o(this,(function(i){return[2,t.openBox("INBOX").then((function(){return r(void 0,void 0,void 0,(function(){var i,u,a,s;return o(this,(function(c){return(i=new Date).setTime(Date.now()-36e5),u=i.toISOString(),a=["ALL","SINCE",u],s={bodies:[""]},[2,t.search(a,s).then((function(t){t.forEach((function(t){var i=v.default.find(t.parts,{which:""}),u=t.attributes.uid;I("Imap-Id: "+u+"\r\n"+(null==i?void 0:i.body),(function(t,i){return r(void 0,void 0,void 0,(function(){var r,u,a,s;return o(this,(function(o){switch(o.label){case 0:return t?(console.error(t),[2]):(console.log(i.subject),(r=null===(a=i.text)||void 0===a?void 0:a.split("\n").filter((function(e){return e&&/^\S+$/.test(e)})))&&(null===(s=i.text)||void 0===s?void 0:s.includes("Instagram"))&&r.length>0?(u=r[0],console.log(u),[4,n.updateChallenge({challengeUrl:m,securityCode:u})]):[3,4]);case 1:return o.sent(),console.info("Answered instagram security challenge with answer code: "+u),[4,n.login()];case 2:return o.sent(),[4,e()];case 3:o.sent(),o.label=4;case 4:return[2]}}))}))}))}))}))]}))}))}))]}))}))}))}),45e3),[2]}))}))];case 7:y.sent(),y.label=8;case 8:return[3,9];case 9:return[2]}}))}))})()];case 1:return n.sent(),[2]}}))}))})),w.get("/",(function(e,n){n.send("welcome..")}));var C=process.env.PORT||9999;w.listen(C,(function(){return"Server is running on port: "+C}))},376:e=>{e.exports=require("axios")},715:e=>{e.exports=require("contentful-management")},349:e=>{e.exports=require("dayjs")},334:e=>{e.exports=require("dotenv")},127:e=>{e.exports=require("express")},747:e=>{e.exports=require("fs")},225:e=>{e.exports=require("imap-simple")},625:e=>{e.exports=require("instagram-web-api")},249:e=>{e.exports=require("jimp")},804:e=>{e.exports=require("lodash")},874:e=>{e.exports=require("mailparser")},199:e=>{e.exports=require("node-cron")},622:e=>{e.exports=require("path")}},n={};!function t(r){var o=n[r];if(void 0!==o)return o.exports;var i=n[r]={exports:{}};return e[r].call(i.exports,i,i.exports,t),i.exports}(450)})();